{% extends 'dashboard/layout.html.twig' %}

{% set isTermine = prestation.statut.value == 'terminé' and not editMode|default(false) %}

{% block title %}Prestation - {{ prestation.bonDeCommande.clientNom }}{% endblock %}

{% block content %}
<style>
    .prestation-detail-container {
        max-width: 1000px;
        margin: 0 auto;
    }

    /* ===== HEADER ===== */
    .detail-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 20px 24px 24px;
        border-radius: 8px 8px 0 0;
        margin-bottom: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .detail-header.header-termine {
        background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
    }

    .detail-header.header-en-cours {
        background: linear-gradient(135deg, #fb8c00 0%, #ef6c00 100%);
    }

    .detail-header.header-non-effectue {
        background: linear-gradient(135deg, #757575 0%, #616161 100%);
    }

    body.dark-mode .detail-header {
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .header-top-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        color: rgba(255,255,255,0.9);
        text-decoration: none;
        font-size: 0.875rem;
        padding: 6px 12px;
        border-radius: 20px;
        background: rgba(255,255,255,0.15);
        transition: background 0.2s;
    }

    .back-btn:hover {
        background: rgba(255,255,255,0.25);
        color: white;
    }

    .back-btn .material-icons {
        font-size: 18px;
    }

    .header-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 16px;
        border-radius: 20px;
        background: rgba(255,255,255,0.2);
        font-size: 0.875rem;
        font-weight: 500;
    }

    .header-status-badge .material-icons {
        font-size: 18px;
    }

    .header-main {
        display: flex;
        align-items: flex-start;
        gap: 16px;
    }

    .header-main .material-icons.header-icon {
        font-size: 36px;
        opacity: 0.9;
        margin-top: 2px;
    }

    .header-info {
        flex: 1;
    }

    .header-info h2 {
        margin: 0 0 6px;
        font-size: 1.6rem;
        font-weight: 400;
    }

    .header-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .header-meta-item {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .header-meta-item .material-icons {
        font-size: 16px;
    }

    /* ===== ADMIN NOTE CALLOUT ===== */
    .admin-note-callout {
        background: #fff3e0;
        border: 1px solid #ffe0b2;
        border-left: 4px solid #ff9800;
        border-radius: 8px;
        padding: 16px 20px;
        margin-bottom: 24px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }

    body.dark-mode .admin-note-callout {
        background: rgba(255, 152, 0, 0.1);
        border-color: rgba(255, 152, 0, 0.3);
    }

    .admin-note-callout .material-icons {
        color: #ff9800;
        font-size: 24px;
        margin-top: 2px;
    }

    .admin-note-callout .note-label {
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #e65100;
        margin-bottom: 4px;
    }

    body.dark-mode .admin-note-callout .note-label {
        color: #ffb74d;
    }

    .admin-note-callout .note-content {
        font-size: 0.95rem;
        color: var(--text-light);
        line-height: 1.5;
    }

    body.dark-mode .admin-note-callout .note-content {
        color: var(--text-dark);
    }

    /* ===== INFO CARD ===== */
    .info-card {
        background: var(--card-light);
        border-radius: 0 0 8px 8px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    body.dark-mode .info-card {
        background: var(--card-dark);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .info-block {
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }

    .info-block .material-icons {
        color: var(--primary);
        font-size: 24px;
        margin-top: 2px;
    }

    .info-content {
        flex: 1;
    }

    .info-label {
        font-size: 0.875rem;
        color: #757575;
        margin-bottom: 4px;
        font-weight: 500;
    }

    body.dark-mode .info-label {
        color: #b0b0b0;
    }

    .info-value {
        font-size: 1rem;
        color: var(--text-light);
    }

    body.dark-mode .info-value {
        color: var(--text-dark);
    }

    .gps-nav-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-top: 8px;
        padding: 6px 14px;
        border-radius: 20px;
        background: #e8f5e9;
        color: #2e7d32;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 500;
        transition: background 0.2s, transform 0.2s;
    }

    .gps-nav-btn:hover {
        background: #c8e6c9;
        transform: scale(1.03);
        color: #1b5e20;
    }

    .gps-nav-btn .material-icons {
        font-size: 18px;
    }

    body.dark-mode .gps-nav-btn {
        background: rgba(46, 125, 50, 0.2);
        color: #81c784;
    }

    body.dark-mode .gps-nav-btn:hover {
        background: rgba(46, 125, 50, 0.35);
    }

    /* ===== SECTION CARDS ===== */
    .section-card {
        background: var(--card-light);
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    body.dark-mode .section-card {
        background: var(--card-dark);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
        color: var(--text-light);
        font-size: 1.5rem;
        font-weight: 400;
    }

    body.dark-mode .section-title {
        color: var(--text-dark);
    }

    .section-title .material-icons {
        color: var(--primary);
        font-size: 28px;
    }

    /* ===== READ-ONLY DESCRIPTION ===== */
    .description-readonly {
        padding: 20px;
        background: #fafafa;
        border: 1px solid var(--border-light);
        border-radius: 8px;
        line-height: 1.6;
        color: var(--text-light);
        font-size: 0.95rem;
        min-height: 100px;
    }

    body.dark-mode .description-readonly {
        background: #2a2a2a;
        border-color: var(--border-dark);
        color: var(--text-dark);
    }

    .description-readonly p { margin: 0 0 12px; }
    .description-readonly p:last-child { margin-bottom: 0; }
    .description-readonly ul, .description-readonly ol { margin: 8px 0; padding-left: 24px; }

    .description-empty {
        color: #999;
        font-style: italic;
    }

    /* ===== QUILL EDITOR ===== */
    .quill-wrapper {
        border: 2px solid var(--border-light);
        border-radius: 8px;
        overflow: hidden;
    }

    body.dark-mode .quill-wrapper {
        border-color: var(--border-dark);
    }

    .ql-toolbar.ql-snow {
        border: none !important;
        border-bottom: 1px solid var(--border-light) !important;
        background: #fafafa;
        padding: 8px 12px !important;
    }

    body.dark-mode .ql-toolbar.ql-snow {
        background: #333;
        border-bottom-color: var(--border-dark) !important;
    }

    body.dark-mode .ql-toolbar .ql-stroke {
        stroke: #ccc !important;
    }

    body.dark-mode .ql-toolbar .ql-fill {
        fill: #ccc !important;
    }

    body.dark-mode .ql-toolbar .ql-picker-label {
        color: #ccc !important;
    }

    body.dark-mode .ql-toolbar button:hover .ql-stroke,
    body.dark-mode .ql-toolbar .ql-picker-label:hover .ql-stroke {
        stroke: white !important;
    }

    body.dark-mode .ql-toolbar button:hover .ql-fill,
    body.dark-mode .ql-toolbar .ql-picker-label:hover .ql-fill {
        fill: white !important;
    }

    body.dark-mode .ql-toolbar button.ql-active .ql-stroke {
        stroke: var(--primary) !important;
    }

    body.dark-mode .ql-toolbar button.ql-active .ql-fill {
        fill: var(--primary) !important;
    }

    .ql-container.ql-snow {
        border: none !important;
        font-family: Roboto, Arial, sans-serif;
        font-size: 14px;
        min-height: 300px;
    }

    .ql-editor {
        min-height: 300px;
        line-height: 1.6;
        color: var(--text-light);
    }

    body.dark-mode .ql-editor {
        color: var(--text-dark);
    }

    body.dark-mode .ql-container.ql-snow {
        background: #2a2a2a;
    }

    .ql-editor.ql-blank::before {
        color: #999;
        font-style: italic;
    }

    body.dark-mode .ql-editor.ql-blank::before {
        color: #666;
    }

    body.dark-mode .ql-snow .ql-picker-options {
        background: #444 !important;
    }

    body.dark-mode .ql-snow .ql-picker-item {
        color: #ccc !important;
    }

    /* ===== SIGNATURE ===== */
    .signature-wrapper {
        margin-top: 16px;
    }

    .signature-canvas-container {
        position: relative;
        margin-bottom: 12px;
    }

    #signature-pad {
        width: 100%;
        height: 250px;
        border: 2px solid var(--border-light);
        border-radius: 4px;
        background: white;
        touch-action: none;
        cursor: crosshair;
    }

    body.dark-mode #signature-pad {
        border-color: var(--border-dark);
        background: #2a2a2a;
    }

    .signature-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .saved-signature {
        margin-top: 24px;
        padding: 20px;
        background: #fafafa;
        border-radius: 4px;
        border: 1px solid var(--border-light);
    }

    body.dark-mode .saved-signature {
        background: #2a2a2a;
        border-color: var(--border-dark);
    }

    .saved-signature h4 {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        color: var(--text-light);
        font-size: 1.125rem;
        font-weight: 500;
    }

    body.dark-mode .saved-signature h4 {
        color: var(--text-dark);
    }

    .saved-signature .material-icons {
        color: #4caf50;
    }

    .saved-signature img {
        max-width: 100%;
        height: auto;
        border: 1px solid var(--border-light);
        border-radius: 4px;
        background: white;
    }

    body.dark-mode .saved-signature img {
        border-color: var(--border-dark);
    }

    /* ===== ALERTS ===== */
    .alert-success {
        background: #4caf50;
        color: white;
        padding: 16px 24px;
        border-radius: 4px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .alert-success .material-icons {
        font-size: 24px;
    }

    /* ===== ACTION BUTTONS ===== */
    .action-buttons {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        margin-top: 32px;
    }

    .action-buttons button,
    .action-buttons a {
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 1rem;
        text-decoration: none;
    }

    .helper-text {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #757575;
        font-size: 0.875rem;
        margin-bottom: 12px;
        padding: 12px;
        background: rgba(63, 81, 181, 0.05);
        border-radius: 4px;
    }

    body.dark-mode .helper-text {
        color: #b0b0b0;
        background: rgba(63, 81, 181, 0.1);
    }

    .helper-text .material-icons {
        font-size: 20px;
        color: var(--primary);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
        .detail-header {
            padding: 16px;
        }

        .header-info h2 {
            font-size: 1.3rem;
        }

        .header-top-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .header-meta {
            flex-direction: column;
            gap: 6px;
        }

        .info-card,
        .section-card {
            padding: 16px;
        }

        .info-grid {
            grid-template-columns: 1fr;
        }

        #signature-pad {
            height: 200px;
        }

        .signature-actions {
            flex-direction: column;
        }

        .signature-actions button {
            width: 100%;
        }
    }
</style>

<div class="prestation-detail-container">

    {# ===== HEADER ===== #}
    <div class="detail-header {% if isTermine %}header-termine{% elseif prestation.statut.value == 'en cours' %}header-en-cours{% elseif prestation.statut.value == 'non effectué' %}header-non-effectue{% endif %}">
        <div class="header-top-row">
            <a href="{{ path('app_user_prestations', {date: prestation.datePrestation|date('Y-m-d')}) }}" class="back-btn">
                <i class="material-icons">arrow_back</i>
                Retour au planning
            </a>
            <div style="display: flex; align-items: center; gap: 8px;">
                {% if isTermine %}
                    <a href="{{ path('app_user_prestation_view', {id: prestation.id, edit: 1}) }}" class="back-btn" style="background: rgba(255,255,255,0.25);">
                        <i class="material-icons">edit</i>
                        Modifier
                    </a>
                {% endif %}
                <span class="header-status-badge">
                    <i class="material-icons">{{ prestation.statut.icon() }}</i>
                    {{ prestation.statut.label() }}
                </span>
            </div>
        </div>

        <div class="header-main">
            <i class="material-icons header-icon">assignment</i>
            <div class="header-info">
                <h2>{{ prestation.bonDeCommande.clientNom }}</h2>
                <div class="header-meta">
                    <span class="header-meta-item">
                        <i class="material-icons">event</i>
                        {{ prestation.datePrestation|date('d/m/Y') }}
                    </span>
                    <span class="header-meta-item">
                        <i class="material-icons">access_time</i>
                        {{ prestation.datePrestation|date('H:i') }}
                    </span>
                    {% if prestation.bonDeCommande.typePrestation %}
                    <span class="header-meta-item">
                        <i class="material-icons">work</i>
                        {{ prestation.bonDeCommande.typePrestation.nom }}
                    </span>
                    {% endif %}
                    {% if prestation.bonDeCommande.numeroCommande %}
                    <span class="header-meta-item">
                        <i class="material-icons">receipt</i>
                        BC #{{ prestation.bonDeCommande.numeroCommande }}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# ===== INFO CARD ===== #}
    <div class="info-card">
        <div class="info-grid">
            <div class="info-block">
                <i class="material-icons">location_on</i>
                <div class="info-content">
                    <div class="info-label">Adresse</div>
                    <div class="info-value">
                        {{ prestation.bonDeCommande.clientAdresse }}
                        {% if prestation.bonDeCommande.clientComplementAdresse %}
                            <br>{{ prestation.bonDeCommande.clientComplementAdresse }}
                        {% endif %}
                    </div>
                    {% set fullAddress = prestation.bonDeCommande.clientAdresse ~ (prestation.bonDeCommande.clientComplementAdresse ? ' ' ~ prestation.bonDeCommande.clientComplementAdresse : '') %}
                    <a href="https://www.google.com/maps/search/?api=1&query={{ fullAddress|url_encode }}"
                       target="_blank" class="gps-nav-btn">
                        <i class="material-icons">navigation</i>
                        Naviguer
                    </a>
                </div>
            </div>

            <div class="info-block">
                <i class="material-icons">phone</i>
                <div class="info-content">
                    <div class="info-label">Téléphone</div>
                    <div class="info-value">{{ prestation.bonDeCommande.clientTelephone }}</div>
                </div>
            </div>

            {% if prestation.bonDeCommande.clientEmail %}
            <div class="info-block">
                <i class="material-icons">email</i>
                <div class="info-content">
                    <div class="info-label">Email</div>
                    <div class="info-value">{{ prestation.bonDeCommande.clientEmail }}</div>
                </div>
            </div>
            {% endif %}

            <div class="info-block">
                <i class="material-icons">format_list_numbered</i>
                <div class="info-content">
                    <div class="info-label">Passage</div>
                    <div class="info-value">
                        {{ prestation.bonDeCommande.nombrePrestations }} / {{ prestation.bonDeCommande.nombrePrestationsNecessaires }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# ===== ADMIN NOTE (shown if description exists) ===== #}
    {% if prestation.description and prestation.description|striptags|trim is not empty %}
    <div class="admin-note-callout">
        <i class="material-icons">campaign</i>
        <div>
            <div class="note-label">Consignes de l'admin</div>
            <div class="note-content">{{ prestation.description|striptags }}</div>
        </div>
    </div>
    {% endif %}

    {# ===== PREVIOUS INTERVENTIONS ===== #}
    {% set autresPrestations = prestation.bonDeCommande.prestations|filter(p => p.id != prestation.id and p.statut.value == 'terminé') %}
    {% if autresPrestations|length > 0 %}
    <div class="section-card">
        <div class="section-title">
            <i class="material-icons">history</i>
            <span>Interventions précédentes ({{ autresPrestations|length }})</span>
        </div>

        <div class="helper-text">
            <i class="material-icons">info</i>
            <span>Récapitulatif des interventions déjà effectuées pour ce bon de commande</span>
        </div>

        {% for autre in autresPrestations %}
        <div style="padding: 16px; margin-bottom: 12px; background: rgba(63, 81, 181, 0.05); border-radius: 8px; border-left: 4px solid #2e7d32;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px; margin-bottom: 12px;">
                <div>
                    <div style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: var(--text-light); margin-bottom: 6px;">
                        <i class="material-icons" style="font-size: 18px; color: var(--primary);">event</i>
                        {{ autre.datePrestation|date('d/m/Y à H:i') }}
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #757575;">
                        <i class="material-icons" style="font-size: 16px;">person</i>
                        {{ autre.employe ? autre.employe.nom : 'Non assigné' }}
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <a href="{{ path('prestation_pdf', {id: autre.id}) }}" target="_blank" class="mdl-button mdl-js-button mdl-button--raised" style="background: #e8f5e9; color: #2e7d32;">
                        <i class="material-icons" style="vertical-align: middle; margin-right: 4px;">picture_as_pdf</i>
                        PDF
                    </a>
                </div>
            </div>

            {% if autre.compteRendu %}
            <div style="padding: 10px; background: rgba(63, 81, 181, 0.03); border-radius: 4px; border-left: 3px solid var(--primary); font-size: 0.9rem; color: var(--text-light); line-height: 1.5; max-height: 100px; overflow-y: auto;">
                {{ autre.compteRendu|raw }}
            </div>
            {% endif %}

            {% if autre.signature %}
            <div style="margin-top: 10px;">
                <img src="{{ autre.signature }}" alt="Signature" style="max-width: 150px; max-height: 60px; border: 1px solid var(--border-light); border-radius: 4px; background: white;">
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {# Flash messages gérés par le layout global #}

    {# ===== TERMINATED MODE: READ-ONLY ===== #}
    {% if isTermine %}

        {# Compte-rendu read-only #}
        <div class="section-card">
            <div class="section-title">
                <i class="material-icons">description</i>
                <span>Compte-rendu d'intervention</span>
            </div>

            <div class="description-readonly">
                {% if prestation.compteRendu and prestation.compteRendu|striptags|trim is not empty %}
                    {{ prestation.compteRendu|raw }}
                {% else %}
                    <span class="description-empty">Aucun compte-rendu renseigné.</span>
                {% endif %}
            </div>
        </div>

        {# Infos intervention read-only #}
        {% set infos = prestation.infosIntervention ?? {} %}
        {% if infos is not empty %}
        <div class="section-card">
            <div class="section-title">
                <i class="material-icons">fact_check</i>
                <span>Informations intervention</span>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: rgba(63, 81, 181, 0.05); border-radius: 8px;">
                    <i class="material-icons" style="color: {{ infos.presenceConstatee|default('') == 'oui' ? '#4caf50' : '#ef5350' }};">
                        {{ infos.presenceConstatee|default('') == 'oui' ? 'person' : 'person_off' }}
                    </i>
                    <div>
                        <div style="font-size: 0.8rem; color: #757575;">Présence constatée</div>
                        <div style="font-weight: 500;">{{ infos.presenceConstatee|default('-')|capitalize }}</div>
                    </div>
                </div>

                <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: rgba(63, 81, 181, 0.05); border-radius: 8px;">
                    <i class="material-icons" style="color: {{ infos.niveauInfestation|default('') == 'eleve' ? '#ef5350' : (infos.niveauInfestation|default('') == 'moyen' ? '#ff9800' : '#4caf50') }};">
                        bug_report
                    </i>
                    <div>
                        <div style="font-size: 0.8rem; color: #757575;">Niveau d'infestation</div>
                        <div style="font-weight: 500;">{{ infos.niveauInfestation|default('-')|capitalize }}</div>
                    </div>
                </div>

                <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: rgba(63, 81, 181, 0.05); border-radius: 8px;">
                    <i class="material-icons" style="color: {{ infos.logementPropre|default('') == 'oui' ? '#4caf50' : '#ef5350' }};">
                        {{ infos.logementPropre|default('') == 'oui' ? 'cleaning_services' : 'warning' }}
                    </i>
                    <div>
                        <div style="font-size: 0.8rem; color: #757575;">Logement propre</div>
                        <div style="font-weight: 500;">{{ infos.logementPropre|default('-')|capitalize }}</div>
                    </div>
                </div>

                <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: rgba(63, 81, 181, 0.05); border-radius: 8px;">
                    <i class="material-icons" style="color: {{ infos.logementEncombre|default('') == 'oui' ? '#ef5350' : '#4caf50' }};">
                        {{ infos.logementEncombre|default('') == 'oui' ? 'inventory_2' : 'check_circle' }}
                    </i>
                    <div>
                        <div style="font-size: 0.8rem; color: #757575;">Logement encombré</div>
                        <div style="font-weight: 500;">{{ infos.logementEncombre|default('-')|capitalize }}</div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {# Custom fields read-only #}
        {% set typePrestation = prestation.bonDeCommande ? prestation.bonDeCommande.typePrestation : prestation.typePrestation %}
        {% if typePrestation and typePrestation.champsPersonnalises is not empty %}
        <div class="section-card">
            <div class="section-title">
                <i class="material-icons">checklist</i>
                <span>Détails de l'intervention</span>
            </div>

            {% set valeurs = prestation.valeursChampsPersonnalises ?? [] %}
            <div style="display: grid; gap: 10px;">
                {% for champ in typePrestation.champsPersonnalises|sort((a, b) => a.position <=> b.position) %}
                    {% set valeur = null %}
                    {% for v in valeurs %}
                        {% if v.label == champ.label %}
                            {% set valeur = v %}
                        {% endif %}
                    {% endfor %}

                    <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: rgba(63, 81, 181, 0.05); border-radius: 8px;">
                        <i class="material-icons" style="color: {{ valeur.checked|default(false) ? '#4caf50' : '#bdbdbd' }}; font-size: 24px;">
                            {{ valeur.checked|default(false) ? 'check_box' : 'check_box_outline_blank' }}
                        </i>
                        <span style="flex: 1; font-weight: 500;">{{ champ.label }}</span>
                        {% if champ.type == 'checkbox_number' and valeur.value is defined and valeur.value is not null %}
                            <span style="background: var(--primary); color: white; padding: 4px 14px; border-radius: 16px; font-size: 0.9rem; font-weight: 500;">
                                {{ valeur.value }}
                            </span>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {# Signature read-only #}
        {% if prestation.signature %}
        <div class="section-card">
            <div class="section-title">
                <i class="material-icons">draw</i>
                <span>Signature du client</span>
            </div>

            <div class="saved-signature" style="margin-top: 0;">
                <h4>
                    <i class="material-icons">check_circle</i>
                    Signature enregistrée
                </h4>
                <img src="{{ prestation.signature }}" alt="Signature client">
            </div>
        </div>
        {% endif %}

        {# PDF section #}
        <div class="section-card">
            <div class="section-title">
                <i class="material-icons">picture_as_pdf</i>
                <span>Aperçu du PDF</span>
            </div>

            <div class="helper-text">
                <i class="material-icons">info</i>
                <span>Votre prestation est terminée. Vous pouvez consulter le PDF ci-dessous.</span>
            </div>

            <div style="text-align: center; margin-bottom: 16px;">
                <a href="{{ path('prestation_pdf', {id: prestation.id}) }}" target="_blank" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                    <i class="material-icons" style="vertical-align: middle; margin-right: 4px;">download</i>
                    Télécharger le PDF
                </a>
            </div>

            <div style="border: 2px solid var(--border-light); border-radius: 8px; overflow: hidden;">
                <iframe
                    src="{{ path('prestation_pdf', {id: prestation.id}) }}"
                    style="width: 100%; height: 800px; border: none;"
                    title="Aperçu PDF">
                </iframe>
            </div>
        </div>

    {# ===== ACTIVE MODE: EDITABLE ===== #}
    {% else %}

        <form method="post" id="prestation-form" data-turbo="false">

            {# Compte-rendu with Quill #}
            <div class="section-card">
                <div class="section-title">
                    <i class="material-icons">description</i>
                    <span>Compte-rendu d'intervention</span>
                </div>

                <div class="helper-text">
                    <i class="material-icons">info</i>
                    <span>Décrivez en détail les travaux effectués, observations et remarques</span>
                </div>

                <input type="hidden" name="compte_rendu" id="compte-rendu-input">
                <div class="quill-wrapper">
                    <div id="quill-editor">{{ prestation.compteRendu|raw }}</div>
                </div>
            </div>

            {# Infos intervention #}
            {% set infos = prestation.infosIntervention ?? {} %}
            <div class="section-card">
                <div class="section-title">
                    <i class="material-icons">fact_check</i>
                    <span>Informations intervention</span>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    {# Présence constatée #}
                    <div style="padding: 14px 16px; background: rgba(63, 81, 181, 0.05); border-radius: 8px; border-left: 4px solid var(--primary);">
                        <div style="font-weight: 500; margin-bottom: 8px;">Présence constatée</div>
                        <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer; margin-right: 16px;">
                            <input type="radio" name="presence_constatee" value="oui" {{ infos.presenceConstatee|default('') == 'oui' ? 'checked' : '' }}> Oui
                        </label>
                        <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="radio" name="presence_constatee" value="non" {{ infos.presenceConstatee|default('') == 'non' ? 'checked' : '' }}> Non
                        </label>
                    </div>

                    {# Niveau infestation #}
                    <div style="padding: 14px 16px; background: rgba(63, 81, 181, 0.05); border-radius: 8px; border-left: 4px solid var(--primary);">
                        <div style="font-weight: 500; margin-bottom: 8px;">Niveau d'infestation</div>
                        <select name="niveau_infestation" style="width: 100%; padding: 8px; border: 1px solid var(--border-light); border-radius: 6px; font-size: 0.95rem; background: var(--card-light); color: var(--text-light);">
                            <option value="">--</option>
                            <option value="faible" {{ infos.niveauInfestation|default('') == 'faible' ? 'selected' : '' }}>Faible</option>
                            <option value="moyen" {{ infos.niveauInfestation|default('') == 'moyen' ? 'selected' : '' }}>Moyen</option>
                            <option value="eleve" {{ infos.niveauInfestation|default('') == 'eleve' ? 'selected' : '' }}>Élevé</option>
                        </select>
                    </div>

                    {# Logement propre #}
                    <div style="padding: 14px 16px; background: rgba(63, 81, 181, 0.05); border-radius: 8px; border-left: 4px solid var(--primary);">
                        <div style="font-weight: 500; margin-bottom: 8px;">Logement propre</div>
                        <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer; margin-right: 16px;">
                            <input type="radio" name="logement_propre" value="oui" {{ infos.logementPropre|default('') == 'oui' ? 'checked' : '' }}> Oui
                        </label>
                        <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="radio" name="logement_propre" value="non" {{ infos.logementPropre|default('') == 'non' ? 'checked' : '' }}> Non
                        </label>
                    </div>

                    {# Logement encombré #}
                    <div style="padding: 14px 16px; background: rgba(63, 81, 181, 0.05); border-radius: 8px; border-left: 4px solid var(--primary);">
                        <div style="font-weight: 500; margin-bottom: 8px;">Logement encombré</div>
                        <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer; margin-right: 16px;">
                            <input type="radio" name="logement_encombre" value="oui" {{ infos.logementEncombre|default('') == 'oui' ? 'checked' : '' }}> Oui
                        </label>
                        <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="radio" name="logement_encombre" value="non" {{ infos.logementEncombre|default('') == 'non' ? 'checked' : '' }}> Non
                        </label>
                    </div>
                </div>
            </div>

            {# Custom fields editable #}
            {% set typePrestation = prestation.bonDeCommande ? prestation.bonDeCommande.typePrestation : prestation.typePrestation %}
            {% if typePrestation and typePrestation.champsPersonnalises is not empty %}
            <div class="section-card">
                <div class="section-title">
                    <i class="material-icons">checklist</i>
                    <span>Détails de l'intervention</span>
                </div>

                <div class="helper-text">
                    <i class="material-icons">info</i>
                    <span>Cochez les cases correspondantes et renseignez les valeurs numériques si nécessaire</span>
                </div>

                <input type="hidden" name="valeurs_champs_personnalises" id="valeurs-champs-input">

                {% set valeurs = prestation.valeursChampsPersonnalises ?? [] %}
                <div id="custom-fields-employee" style="display: grid; gap: 10px;">
                    {% for champ in typePrestation.champsPersonnalises|sort((a, b) => a.position <=> b.position) %}
                        {% set valeur = null %}
                        {% for v in valeurs %}
                            {% if v.label == champ.label %}
                                {% set valeur = v %}
                            {% endif %}
                        {% endfor %}

                        <div class="custom-field-input" data-label="{{ champ.label }}" data-type="{{ champ.type }}"
                             style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: rgba(63, 81, 181, 0.05); border-radius: 8px; border-left: 4px solid var(--primary);">

                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="champ-checkbox"
                                       {{ valeur.checked|default(false) ? 'checked' : '' }}
                                       style="width: 20px; height: 20px; accent-color: var(--primary); cursor: pointer;">
                            </label>

                            <span style="flex: 1; font-weight: 500; font-size: 1rem;">{{ champ.label }}</span>

                            {% if champ.type == 'checkbox_number' %}
                                <input type="number" class="champ-number" min="0"
                                       value="{{ valeur.value|default('') }}"
                                       placeholder="Nb"
                                       style="width: 70px; text-align: center; border: 1px solid var(--border-light); border-radius: 6px; padding: 8px; font-size: 0.95rem; background: var(--card-light); color: var(--text-light);">
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# Signature pad #}
            <div class="section-card">
                <div class="section-title">
                    <i class="material-icons">draw</i>
                    <span>Signature du client</span>
                </div>

                <div class="helper-text">
                    <i class="material-icons">touch_app</i>
                    <span>Dessinez la signature avec votre souris ou votre doigt sur l'écran tactile</span>
                </div>

                <div class="signature-wrapper">
                    <div class="signature-canvas-container">
                        <canvas id="signature-pad"></canvas>
                        <input type="hidden" name="signature" id="signature-input">
                    </div>

                    <div class="signature-actions">
                        <button type="button" id="clear" class="mdl-button mdl-js-button mdl-button--raised">
                            <i class="material-icons" style="vertical-align: middle; margin-right: 4px;">clear</i>
                            Effacer
                        </button>
                        <button type="button" id="undo" class="mdl-button mdl-js-button mdl-button--raised">
                            <i class="material-icons" style="vertical-align: middle; margin-right: 4px;">undo</i>
                            Annuler
                        </button>
                    </div>
                </div>

                {% if prestation.signature %}
                    <div class="saved-signature">
                        <h4>
                            <i class="material-icons">check_circle</i>
                            Signature enregistrée
                        </h4>
                        <img src="{{ prestation.signature }}" alt="Signature client">
                    </div>
                {% endif %}
            </div>

            {# Action buttons #}
            <div class="action-buttons">
                {% if prestation.statut.value == 'terminé' %}
                    {# Mode édition d'une prestation déjà terminée #}
                    <button type="submit" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                        <i class="material-icons">save</i>
                        Enregistrer les corrections
                    </button>
                    <a href="{{ path('app_user_prestation_view', {id: prestation.id}) }}" class="mdl-button mdl-js-button mdl-button--raised">
                        <i class="material-icons">close</i>
                        Annuler
                    </a>
                {% else %}
                    {# Prestation en cours : valider directement #}
                    <button type="submit" name="valider" value="1" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent"
                            onclick="return confirm('Êtes-vous sûr de vouloir valider cette prestation ?');">
                        <i class="material-icons">check_circle</i>
                        Valider l'intervention
                    </button>
                {% endif %}
            </div>
        </form>

    {% endif %}

</div>

{% if not isTermine %}
{# ===== SCRIPTS (only loaded when editable) ===== #}

<!-- Quill Editor -->
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>

<!-- Signature Pad -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<script>
// ==================== QUILL INIT ====================
const quill = new Quill('#quill-editor', {
    theme: 'snow',
    placeholder: 'Décrivez les travaux effectués...',
    modules: {
        toolbar: [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'align': [] }],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            [{ 'indent': '-1' }, { 'indent': '+1' }],
            ['link'],
            ['clean']
        ]
    }
});

// ==================== SIGNATURE PAD ====================
const canvas = document.getElementById('signature-pad');
let signaturePad;
let signatureData = null;

function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const newWidth = canvas.offsetWidth;
    const newHeight = 250;

    if (signaturePad && !signaturePad.isEmpty()) {
        signatureData = signaturePad.toData();
    }

    canvas.width = newWidth * ratio;
    canvas.height = newHeight * ratio;

    const ctx = canvas.getContext("2d");
    ctx.scale(ratio, ratio);

    const isDark = document.body.classList.contains('dark-mode');
    ctx.fillStyle = isDark ? '#2a2a2a' : 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    if (signaturePad) {
        signaturePad.off();
    }

    signaturePad = new SignaturePad(canvas, {
        backgroundColor: isDark ? 'rgba(42, 42, 42, 1)' : 'rgba(255, 255, 255, 1)',
        penColor: isDark ? '#e0e0e0' : 'black',
    });

    if (signatureData) {
        signaturePad.fromData(signatureData);
    }
}

function initSignature() {
    resizeCanvas();
}

initSignature();

window.addEventListener("resize", resizeCanvas);

// Clear button
document.getElementById('clear').addEventListener('click', () => {
    signaturePad.clear();
    signatureData = null;

    const ctx = canvas.getContext("2d");
    const isDark = document.body.classList.contains('dark-mode');
    ctx.fillStyle = isDark ? '#2a2a2a' : 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
});

// Undo button
document.getElementById('undo').addEventListener('click', () => {
    const data = signaturePad.toData();
    if (data && data.length > 0) {
        data.pop();
        signaturePad.fromData(data);
    }
});

// Form submission - sync Quill + Signature + Custom fields
document.getElementById('prestation-form').addEventListener('submit', () => {
    // Sync Quill HTML to hidden input
    const crInput = document.getElementById('compte-rendu-input');
    const html = quill.root.innerHTML;
    crInput.value = (html === '<p><br></p>') ? '' : html;

    // Sync custom fields
    const champsInput = document.getElementById('valeurs-champs-input');
    if (champsInput) {
        const rows = document.querySelectorAll('.custom-field-input');
        const values = [];
        rows.forEach(row => {
            const checkbox = row.querySelector('.champ-checkbox');
            const numberInput = row.querySelector('.champ-number');
            values.push({
                label: row.dataset.label,
                type: row.dataset.type,
                checked: checkbox ? checkbox.checked : false,
                value: numberInput && numberInput.value ? parseInt(numberInput.value) : null
            });
        });
        champsInput.value = JSON.stringify(values);
    }

    // Sync signature
    const sigInput = document.getElementById("signature-input");
    if (!signaturePad.isEmpty()) {
        sigInput.value = signaturePad.toDataURL();
    } else {
        sigInput.value = sigInput.value || "{{ prestation.signature }}";
    }
});
</script>
{% endif %}

{% endblock %}
